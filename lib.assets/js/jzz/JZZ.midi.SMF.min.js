!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?(r.SMF=r,module.exports=r):"function"==typeof define&&define.amd?define("JZZ.midi.SMF",["JZZ"],r):r(JZZ)}(this,function(t){if(!t.MIDI.SMF){var r="1.7.6",i=t.lib.now;$.version=function(){return r},$.num4=a,$.prototype=[],$.prototype.constructor=$,$.prototype.copy=function(){var t=new $;t.type=this.type,t.ppqn=this.ppqn,t.fps=this.fps,t.ppf=this.ppf,t.rmi=this.rmi,t.ntrk=this.ntrk;for(var r=0;r<this.length;r++)t.push(this[r].copy());return t},$.prototype._complain=function(t,r,i){this._warn||(this._warn=[]),this._warn.push(c(t,r,i))},$.prototype.load=function(t){var r=0;"RIFF"==t.substr(0,4)&&"RMIDdata"==t.substr(8,8)&&(this.rmi=!0,r=20,t=t.substr(20,t.charCodeAt(16)+256*t.charCodeAt(17)+65536*t.charCodeAt(18)+16777216*t.charCodeAt(19))),this.loadSMF(t,r)};var n="MThd\0\0\0\x06";$.prototype.loadSMF=function(t,r){if(t.length||o("Empty file"),t.substr(0,8)!=n){var i=t.indexOf(n);-1!=i?(t=t.substr(i),this._complain(r,"Extra leading characters",i),r+=i):o("Not a MIDI file")}this._off=r,this.type=16*t.charCodeAt(8)+t.charCodeAt(9),this._off_type=r+8,this.ntrk=16*t.charCodeAt(10)+t.charCodeAt(11),this._off_ntrk=r+10,t.charCodeAt(12)>127?(this.fps=256-t.charCodeAt(12),this.ppf=t.charCodeAt(13),this._off_fps=r+12,this._off_ppf=r+13):(this.ppqn=256*t.charCodeAt(12)+t.charCodeAt(13),this._off_ppqn=r+12),this.type>2?this._complain(8+r,"Invalid MIDI file type",this.type):0==this.type&&this.ntrk>1&&this._complain(10+r,"Wrong number of tracks for the type 0 MIDI file",this.ntrk),this.ppf||this.ppqn||o("Invalid MIDI header");for(var e=0,s=14;s<t.length-8;){var h=s+r,a=t.substr(s,4);"MTrk"==a&&e++;var f=(t.charCodeAt(s+4)<<24)+(t.charCodeAt(s+5)<<16)+(t.charCodeAt(s+6)<<8)+t.charCodeAt(s+7);f<=0&&(f=t.length-s-8,this._complain(s+r+4,"Invalid track length",t.charCodeAt(s+4)+"/"+t.charCodeAt(s+5)+"/"+t.charCodeAt(s+6)+"/"+t.charCodeAt(s+7))),s+=8;var p=t.substr(s,f);this.push(new v(a,p,h)),"MThd"==a&&this._complain(h,"Unexpected chunk type","MThd"),s+=f}e!=this.ntrk&&(this._complain(r+10,"Incorrect number of tracks",this.ntrk),this.ntrk=e),this.ntrk||o("No MIDI tracks"),(!this.type&&this.ntrk>1||this.type>2)&&(this.type=1),s<t.length&&this._complain(r+s,"Extra trailing characters",t.length-s),s>t.length&&this._complain(r+t.length,"Incomplete data",s-t.length)},u.prototype.toString=function(){var t=[];return void 0!==this.off&&t.push("offset "+this.off),void 0!==this.track&&t.push("track "+this.track),void 0!==this.tick&&t.push("tick "+this.tick),t.join(" ")+" -- "+this.msg+" ("+this.data+")"},$.prototype.tracks=function(){for(var t=0,r=0;r<this.length;r++)this[r]instanceof x&&t++;return t},$.prototype.validate=function(){var t,r,i,n=[];if(this._warn)for(t=0;t<this._warn.length;t++)n.push(u(this._warn[t]));var e=g(this);for(t=0,r=0;t<this.length;t++)this[t]instanceof x&&(this[t]._validate(n,r),r++);var o={};for(d(n,o),t=0;t<e.length;t++)(i=b(e[t],1==this.type))&&(i.track=e[t].track,n.push(i)),l(n,o,e[t]);if(d(n,o),n.sort(function(t,r){return(t.off||0)-(r.off||0)||(t.track||0)-(r.track||0)||(t.tick||0)-(r.tick||0)}),n.length){for(t=0;t<n.length;t++)n[t]=u(n[t]);return n}},$.prototype.dump=function(t){var r="";if(t)return"RIFF"+f((r=this.dump()).length+12)+"RMIDdata"+f(r.length)+r;this.ntrk=0;for(var i=0;i<this.length;i++)this[i]instanceof x&&this.ntrk++,r+=this[i].dump();return r=(this.ppqn?h(this.ppqn):String.fromCharCode(256-this.fps)+String.fromCharCode(this.ppf))+r,r=n+"\0"+String.fromCharCode(this.type)+h(this.ntrk)+r},$.prototype.toBuffer=function(t){return Buffer.from(this.dump(t),"binary")},$.prototype.toUint8Array=function(t){for(var r=this.dump(t),i=new ArrayBuffer(r.length),n=new Uint8Array(i),e=0;e<r.length;e++)n[e]=r.charCodeAt(e);return n},$.prototype.toArrayBuffer=function(t){return this.toUint8Array(t).buffer},$.prototype.toInt8Array=function(t){return new Int8Array(this.toArrayBuffer(t))},$.prototype.toString=function(){for(t=0,this.ntrk=0;t<this.length;t++)this[t]instanceof x&&this.ntrk++;var t,r=["SMF:","  type: "+this.type];for(this.ppqn?r.push("  ppqn: "+this.ppqn):r.push("  fps: "+this.fps,"  ppf: "+this.ppf),r.push("  tracks: "+this.ntrk),t=0;t<this.length;t++)r.push(this[t].toString());return r.join("\n")},$.prototype.annotate=function(){for(var r=g(this),i=t.Context(),n=0;n<r.length;n++)r[n].lbl&&(r[n].lbl=void 0),i._read(r[n]);return this},$.prototype.player=function(){var r,i,n=new M;n.ppqn=this.ppqn,n.fps=this.fps,n.ppf=this.ppf;var e=g(this);if(2==this.type){var o=0,s=0,h=0;for(r=0;r<e.length;r++)o!=(i=t.MIDI(e[r])).track&&(o=i.track,s=h),h=i.tt+s,i.tt=h,n._data.push(i)}else for(r=0;r<e.length;r++)i=t.MIDI(e[r]),n._data.push(i);return n._type=this.type,n._tracks=this.tracks(),n._timing(),n},$.Chunk=v,v.prototype=[],v.prototype.constructor=v,v.prototype.copy=function(){return new v(this.type,this.data)},v.prototype.sub={MTrk:function(t,r,i){return new x(r,i)}},v.prototype.dump=function(){return this.type+a(this.data.length)+this.data},v.prototype.toString=function(){return this.type+": "+this.data.length+" bytes"},$.MTrk=x,x.prototype=[],x.prototype.constructor=x,x.prototype.type="MTrk",x.prototype.copy=function(){var r=new x;r.length=0;for(var i=0;i<this.length;i++)r.push(new t.MIDI(this[i]));return r},x.prototype._validate=function(t,r){var i,n;if(this._warn)for(i=0;i<this._warn.length;i++)(n=u(this._warn[i])).track=r,t.push(n)},x.prototype._complain=function(t,r,i,n){this._warn||(this._warn=[]),this._warn.push(c(t,r,i,n))},x.prototype.dump=function(){var t,r,i="",n=0,e="";for(t=0;t<this.length;t++)if(i+=s(this[t].tt-n),n=this[t].tt,void 0!==this[t].dd)i+="\xff",i+=String.fromCharCode(this[t].ff),i+=s(this[t].dd.length),i+=this[t].dd;else if(240==this[t][0]||247==this[t][0])for(i+=String.fromCharCode(this[t][0]),i+=s(this[t].length-1),r=1;r<this[t].length;r++)i+=String.fromCharCode(this[t][r]);else for(this[t][0]!=e&&(e=this[t][0],i+=String.fromCharCode(this[t][0])),r=1;r<this[t].length;r++)i+=String.fromCharCode(this[t][r]);return"MTrk"+a(i.length)+i},x.prototype.toString=function(){for(var t=["MTrk:"],r=0;r<this.length;r++)t.push(this[r].tt+": "+this[r].toString());return t.join("\n  ")},x.prototype.add=function(r,i){var n;if((isNaN(r=parseInt(r))||r<0)&&o("Invalid parameter"),(i=t.MIDI(i)).tt=r,this[this._orig.length-1].tt<r&&(this[this._orig.length-1].tt=r),47==i.ff||i[0]>240&&247!=i[0])return this;for(n=0;n<this._orig.length-1&&!(this._orig[n].tt>r);n++);return this._orig.splice(n,0,i),this},x.prototype._ch=void 0,x.prototype._sxid=127,x.prototype._image=function(){var t=function(){};t.prototype=this._orig;var r=new t;return r._ch=this._ch,r._sxid=this._sxid,r._tick=this._tick,r},x.prototype.send=function(t){return this._orig.add(this._tick,t),this},x.prototype.tick=function(t){if(t!=parseInt(t)||t<0)throw RangeError("Bad tick value: "+t);if(!t)return this;var r=this._image();return r._tick=this._tick+t,r},x.prototype.sxId=function(t){if(void 0===t&&(t=x.prototype._sxid),t==this._sxid)return this;if(t!=parseInt(t)||t<0||t>127)throw RangeError("Bad MIDI value: "+t);var r=this._image();return r._sxid=t,r},x.prototype.ch=function(t){if(t==this._ch||void 0===t&&void 0===this._ch)return this;if(void 0!==t&&(t!=parseInt(t)||t<0||t>15))throw RangeError("Bad channel value: "+t+" (must be from 0 to 15)");var r=this._image();return r._ch=t,r},x.prototype.note=function(t,r,i,n){return this.noteOn(t,r,i),void 0===this._ch?n>0&&this.tick(n).noteOff(t,r):i>0&&this.tick(i).noteOff(t),this},t.lib.copyMidiHelpers(x),M.prototype.onEnd=function(){},M.prototype.loop=function(t){t==parseInt(t)&&t>0?this._loop=t:this._loop=t?-1:0},M.prototype.play=function(){this.event=void 0,this.playing=!0,this.paused=!1,this._ptr=0,this._pos=0,this._p0=0,this._t0=i(),this.tick()},M.prototype.stop=function(){this._pos=0,this.playing=!1,this.event="stop",this.paused=void 0},M.prototype.pause=function(){this.event="pause"},M.prototype.resume=function(){this.playing||(this.paused?(this.event=void 0,this._t0=i(),this.playing=!0,this.paused=!1,this.tick()):this.play())},M.prototype.sndOff=function(){var r;for(r=0;r<16;r++)this._emit(t.MIDI.allSoundOff(r));for(r=0;r<16;r++)this._emit(t.MIDI.resetAllControllers(r))},M.prototype._filter=w,M.prototype.filter=function(t){this._filter=t instanceof Function?t:w},M.prototype._receive=function(t){81==t.ff&&this.ppqn&&(this._mul=1e3*this.ppqn/D(t.dd),this.mul=this._mul*this._speed,this._t0=i(),this._p0=this._pos),this._emit(t)},M.prototype.tick=function(){var r,n=i();for(this._pos=this._p0+(n-this._t0)*this.mul;this._ptr<this._data.length&&!((r=this._data[this._ptr]).tt>this._pos);this._ptr++)this._filter(r);this._ptr>=this._data.length&&(this._loop&&-1!=this._loop&&this._loop--,this._loop?(this._ptr=0,this._p0=0,this._t0=n):this.stop(),this.onEnd()),"stop"==this.event&&(this.playing=!1,this.paused=!1,this._pos=0,this._ptr=0,this.sndOff(),this.event=void 0),"pause"==this.event&&(this.playing=!1,this.paused=!0,this._pos>=this._duration&&(this._pos=this._duration-1),this._p0=this._pos,this.sndOff(),this.event=void 0),this.playing&&t.lib.schedule(this._tick)},M.prototype.trim=function(){var t,r,i,n=[];for(t=0,r=0;t<this._data.length;t++)if((i=this._data[t]).length||1==i.ff||5==i.ff)for(;r<=t;r++)n.push(this._data[r]);var e=(t?this._data[t-1].tt:0)-(r?this._data[r-1].tt:0);return this._data=n,this._timing(),e},M.prototype._timing=function(){var t,r,i,n;if(this._duration=this._data.length?this._data[this._data.length-1].tt:0,this._ttt=[],this.ppqn){for(this._mul=this.ppqn/500,r=this._mul,i=0,this._durationMS=0,this._ttt.push({t:0,m:r,ms:0}),t=0;t<this._data.length;t++)81==(n=this._data[t]).ff&&(this._durationMS+=(n.tt-i)/r,i=n.tt,r=1e3*this.ppqn/D(n.dd),this._ttt.push({t:i,m:r,ms:this._durationMS}));this._durationMS+=(this._duration-i)/r}else this._mul=this.fps*this.ppf/1e3,this._ttt.push({t:0,m:this._mul,ms:0}),this._durationMS=this._duration/this._mul;this._speed=1,this.mul=this._mul,this._ttt.push({t:this._duration,m:0,ms:this._durationMS}),this._durationMS||(this._durationMS=1)},M.prototype.speed=function(t){return void 0!==t&&((isNaN(parseFloat(t))||t<=0)&&(t=1),this._speed=t,this.mul=this._mul*this._speed,this._p0=this._pos-(i()-this._t0)*this.mul),this._speed},M.prototype.type=function(){return this._type},M.prototype.tracks=function(){return this._tracks},M.prototype.duration=function(){return this._duration},M.prototype.durationMS=function(){return this._durationMS},M.prototype.position=function(){return this._pos},M.prototype.positionMS=function(){return this.tick2ms(this._pos)},M.prototype.jump=function(t){isNaN(parseFloat(t))&&o("Not a number: "+t),t<0&&(t=0),t>=this._duration&&(t=this._duration-1),this._goto(t)},M.prototype.jumpMS=function(t){isNaN(parseFloat(t))&&o("Not a number: "+t),t<0&&(t=0),t>=this._durationMS&&(t=this._durationMS-1),this._goto(this._ms2t(t))},M.prototype._t2ms=function(t){var r;if(!t)return 0;for(r=0;this._ttt[r].t<t;r++);return r--,this._ttt[r].ms+(t-this._ttt[r].t)/this._ttt[r].m},M.prototype._ms2t=function(t){var r;if(!t)return 0;for(r=0;this._ttt[r].ms<t;r++);return r--,this._ttt[r].t+(t-this._ttt[r].ms)*this._ttt[r].m},M.prototype._goto=function(t){this._pos=t,this.playing||(this.paused=!!t),this._toPos(),this.playing&&this.sndOff()},M.prototype._toPos=function(){for(this._ptr=0;this._ptr<this._data.length;this._ptr++){var t=this._data[this._ptr];if(t.tt>=this._pos)break;81==t.ff&&this.ppqn&&(this._mul=1e3*this.ppqn/D(t.dd))}this.mul=this._mul*this._speed,this._t0=i(),this._p0=this._pos},M.prototype.tick2ms=function(t){return(isNaN(parseFloat(t))&&o("Not a number: "+t),t<=0)?0:t>=this._duration?this._durationMS:this._t2ms(t)},M.prototype.ms2tick=function(t){return(isNaN(parseFloat(t))&&o("Not a number: "+t),t<=0)?0:t>=this._durationMS?this._duration:this._ms2t(t)},t.MIDI.SMF=$,q.version=function(){return r},q.prototype=[],q.prototype.constructor=q,q.prototype.copy=function(r){for(var i=0;i<r.length;i++)r[i].isSMF()||(r[i].isFullSysEx()?this.push(t.MIDI(r[i])):N())},q.prototype.validate=function(){return[]},q.prototype.dump=function(){var t,r,i="";for(t=0;t<this.length;t++)for(r=0;r<this[t].length;r++)i+=String.fromCharCode(this[t][r]);return i},q.prototype.toBuffer=function(){return Buffer.from(this.dump(),"binary")},q.prototype.toUint8Array=function(){for(var t=this.dump(),r=new ArrayBuffer(t.length),i=new Uint8Array(r),n=0;n<t.length;n++)i[n]=t.charCodeAt(n);return i},q.prototype.toArrayBuffer=function(){return this.toUint8Array().buffer},q.prototype.toInt8Array=function(){return new Int8Array(this.toArrayBuffer())},q.prototype.toString=function(){var t,r=["SYX:"];for(t=0;t<this.length;t++)r.push(this[t].toString());return r.join("\n  ")},q.prototype.annotate=function(){for(var r=t.Context(),i=0;i<this.length;i++)this[i].lbl&&(this[i].lbl=void 0),r._read(this[i]);return this},q.prototype.player=function(){var r,i=new M;for(r=0,i.ppqn=96;r<this.length;r++){var n=t.MIDI(this[r]);n.tt=0,i._data.push(n)}return i._type=0,i._tracks=1,i._timing(),i.sndOff=function(){},i},q.prototype._ch=void 0,q.prototype._sxid=127,q.prototype._image=function(){var t=function(){};t.prototype=this._orig;var r=new t;return r._ch=this._ch,r._sxid=this._sxid,r},q.prototype.add=function(r){return(r=t.MIDI(r)).isFullSysEx()&&this._orig.push(r),this},q.prototype.send=function(t){return this.add(t)},q.prototype.sxId=function(t){if(void 0===t&&(t=q.prototype._sxid),t==this._sxid)return this;if(t!=parseInt(t)||t<0||t>127)throw RangeError("Bad MIDI value: "+t);var r=this._image();return r._sxid=t,r},q.prototype.ch=function(t){if(t==this._ch||void 0===t&&void 0===this._ch)return this;if(void 0!==t&&(t!=parseInt(t)||t<0||t>15))throw RangeError("Bad channel value: "+t+" (must be from 0 to 15)");var r=this._image();return r._ch=t,r},t.lib.copyMidiHelpers(q),t.MIDI.SYX=q,B.version=function(){return r},B.prototype=[],B.prototype.constructor=B,T.prototype=[],T.prototype.constructor=T;var e="SMF2CLIP";B.prototype.load=function(t){this.loadClip(t,0)},B.prototype.loadClip=function(r,i){if(r.length||o("Empty file"),this.header=new T,r.substr(0,8)!=e){var n,s,h,a,f,p=r.indexOf(e);-1!=p?(r=r.substr(p),this._complain(i,"Extra leading characters",p),i+=p):o("Not a Clip")}i+=8;for(var $=!0;i<r.length;){for(s=0,f=[4,4,4,8,8,16,4,4,8,8,8,12,12,16,16,16][a=r.charCodeAt(i)>>4],n=[];s<f;s++)n.push(r.charCodeAt(i+s));h=t.UMP(n),$&&h.isStartClip()&&($=!1),$?this.header.push(h):this.push(h),i+=f}},T.prototype.toString=function(){var t,r=["Header"];for(t=0;t<this.length;t++)r.push("  "+this[t]);return r.join("\n")},B.prototype.toString=function(){var t,r=[e,this.header.toString(),"Data"];for(t=0;t<this.length;t++)r.push("  "+this[t]);return r.join("\n")},t.MIDI.Clip=B}function o(t){throw Error(t)}function s(t){var r="";return t>2097151&&(r+=String.fromCharCode((t>>21&127)+128)),t>16383&&(r+=String.fromCharCode((t>>14&127)+128)),t>127&&(r+=String.fromCharCode((t>>7&127)+128)),r+=String.fromCharCode(127&t)}function h(t){return String.fromCharCode(t>>8)+String.fromCharCode(255&t)}function a(t){return String.fromCharCode(t>>24&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>8&255)+String.fromCharCode(255&t)}function f(t){return String.fromCharCode(255&t)+String.fromCharCode(t>>8&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>24&255)}function p(t){for(var r="",i=t.byteLength,n=0;n<i;n++)r+=String.fromCharCode(t[n]);return r}function $(){var t=this;t instanceof $||delete(t=new $).ppqn;var r=1,i=96;if(1==arguments.length){if(arguments[0]instanceof $)return arguments[0].copy();if(arguments[0]instanceof q){t.type=0,t.ppqn=i,t.push(new x);for(var n,e,s,h=0;h<arguments[0].length;h++)t[0].add(0,arguments[0][h]);return t}try{arguments[0]instanceof ArrayBuffer&&(s=p(new Uint8Array(arguments[0])))}catch(a){}try{(arguments[0]instanceof Uint8Array||arguments[0]instanceof Int8Array)&&(s=p(new Uint8Array(arguments[0])))}catch(f){}try{arguments[0]instanceof Buffer&&(s=arguments[0].toString("binary"))}catch(c){}if("string"==typeof arguments[0]&&"0"!=arguments[0]&&"1"!=arguments[0]&&"2"!=arguments[0]&&(s=arguments[0]),s)return t.load(s),t;r=parseInt(arguments[0])}else 2==arguments.length?(r=parseInt(arguments[0]),i=parseInt(arguments[1])):3==arguments.length?(r=parseInt(arguments[0]),n=parseInt(arguments[1]),e=parseInt(arguments[2])):arguments.length&&o("Invalid parameters");return(isNaN(r)||r<0||r>2)&&o("Invalid parameters"),t.type=r,void 0===n?((isNaN(i)||i<0||i>65535)&&o("Invalid parameters"),t.ppqn=i):(24!=n&&25!=n&&29!=n&&30!=n&&o("Invalid parameters"),(isNaN(e)||e<0||e>255)&&o("Invalid parameters"),t.fps=n,t.ppf=e),t}function c(t,r,i,n,e){var o={off:t,msg:r,data:i};return void 0!==n&&(o.tick=n),void 0!==e&&(o.track=e),o}function u(t){if(!(this instanceof u))return new u(t);for(var r in t)t.hasOwnProperty(r)&&(this[r]=t[r])}function d(t,r){var i;for(i=0;i<16;i++)r[i]&&(r[i].rm&&r[i].rl&&127==r[i].rm[0][2]&&127==r[i].rl[0][2]&&(r[i].rm[1]=!0,r[i].rl[1]=!0),m(t,r,i,"bm"),m(t,r,i,"bl"),m(t,r,i,"nm"),m(t,r,i,"nl"),m(t,r,i,"rm"),m(t,r,i,"rl")),r[i]={}}function l(t,r,i){if(i.length&&!(i[0]<128)){if(i.isGmReset()||i.isGsReset()||i.isXgReset()){d(t,r);return}var n,e=i[0]>>4,o=15&i[0];if(11==e){switch(i[1]){case 0:m(t,r,o,"bm"),r[o].bm=[i,!1];break;case 32:m(t,r,o,"bl"),r[o].bl=[i,!1];break;case 98:m(t,r,o,"nl"),m(t,r,o,"rm"),m(t,r,o,"rl"),r[o].nl=[i,!1];break;case 99:m(t,r,o,"nm"),m(t,r,o,"rm"),m(t,r,o,"rl"),r[o].nm=[i,!1];break;case 100:m(t,r,o,"rl"),m(t,r,o,"nm"),m(t,r,o,"nl"),r[o].rl=[i,!1];break;case 101:m(t,r,o,"rm"),m(t,r,o,"nm"),m(t,r,o,"nl"),r[o].rm=[i,!1];break;case 6:case 38:case 96:case 97:r[o].rm&&r[o].rl&&(r[o].rm[1]=!0,r[o].rl[1]=!0),!r[o].rm||r[o].rl||r[o].rm[1]||(n=r[o].rm[0],t.push(c(n._off,"No matching RPN LSB",n.toString(),n.tt,n.track)),r[o].rm[1]=!0),r[o].rm||!r[o].rl||r[o].rl[1]||(n=r[o].rl[0],t.push(c(n._off,"No matching RPN MSB",n.toString(),n.tt,n.track)),r[o].rl[1]=!0),r[o].nm&&r[o].nl&&(r[o].nm[1]=!0,r[o].nl[1]=!0),!r[o].nm||r[o].nl||r[o].nm[1]||(n=r[o].nm[0],t.push(c(n._off,"No matching NRPN LSB",n.toString(),n.tt,n.track)),r[o].nm[1]=!0),r[o].nm||!r[o].nl||r[o].nl[1]||(n=r[o].nl[0],t.push(c(n._off,"No matching NRPN MSB",n.toString(),n.tt,n.track)),r[o].nl[1]=!0),r[o].rm||r[o].rl||r[o].nm||r[o].nl||t.push(c(i._off,"RPN/NRPN not set",i.toString(),i.tt,i.track)),r[o].rm&&r[o].rl&&127==r[o].rm[0][2]&&127==r[o].rl[0][2]&&t.push(c(i._off,"RPN/NRPN not set",i.toString(),i.tt,i.track))}return}12==e&&(r[o].bm&&(r[o].bm[1]=!0),r[o].bl&&(r[o].bl[1]=!0),r[o].bl&&!r[o].bm&&(n=r[o].bl[0],t.push(c(n._off,"No matching Bank Select MSB",n.toString(),n.tt,n.track))),r[o].bm&&!r[o].bl&&(n=r[o].bm[0],t.push(c(n._off,"No matching Bank Select LSB",n.toString(),n.tt,n.track))))}}function m(t,r,i,n){if(r[i][n]&&!r[i][n][1]){switch(n){case"bm":case"bl":e="Unnecessary Bank Select";break;case"nm":case"nl":e="Unnecessary NRPN";break;case"rm":case"rl":e="Unnecessary RPN"}var e,o=r[i][n][0];t.push(c(o._off,e,o.toString(),o.tt,o.track)),delete r[i][n]}}function y(t){switch(240&t){case 128:case 144:case 160:case 176:case 224:return 2;case 192:case 208:return 1}switch(t){case 241:case 243:return 1;case 242:return 2}return 0}function g(t){var r,i,n=[],e=[];for(r=0;r<t.length;r++)t[r]instanceof x&&n.push(t[r]);if(1!=t.type)for(r=0;r<n.length;r++)for(i=0;i<n[r].length;i++)n[r][i].track=r,e.push(n[r][i]);else{var o=0,s=[];for(r=0;r<n.length;r++)s[r]=0;for(;;){var h=!0,a=0;for(r=0;r<n.length;r++){for(;s[r]<n[r].length&&n[r][s[r]].tt==o;)n[r][s[r]].track=r,e.push(n[r][s[r]]),s[r]++;!(s[r]>=n[r].length)&&(h&&(a=n[r][s[r]].tt),h=!1,a>n[r][s[r]].tt&&(a=n[r][s[r]].tt))}if(o=a,h)break}}return e}function v(t,r,i){var n;if(!(this instanceof v))return new v(t,r,i);if(this.sub[t])return this.sub[t](t,r,i);for(("string"!=typeof t||4!=t.length)&&o("Invalid chunk type: "+t),n=0;n<t.length;n++)(0>t.charCodeAt(n)||t.charCodeAt(n)>255)&&o("Invalid chunk type: "+t);for("string"!=typeof r&&o("Invalid data type: "+r),n=0;n<r.length;n++)(0>r.charCodeAt(n)||r.charCodeAt(n)>255)&&o("Invalid data character: "+r[n]);this.type=t,this.data=r,this._off=i}function _(t,r,i,n,e,o){var s=r.substr(i,n);s.length<n&&(t._complain(o,"Incomplete track data",n-s.length,e),s=(s+"\0\0").substr(0,n));for(var h=0;h<n;h++)s.charCodeAt(h)>127&&(t._complain(o+h,"Bad MIDI value set to 0",s.charCodeAt(h),e),s=s.substr(0,h)+"\0"+s.substr(h+1));return s}function C(t,r,i,n,e){var o=function t(r){if(!r.length)return 0;if(128>r.charCodeAt(0))return[1,r.charCodeAt(0)];var i=127&r.charCodeAt(0);return(i<<=7,128>r.charCodeAt(1))?[2,i+r.charCodeAt(1)]:(i+=127&r.charCodeAt(1),i<<=7,128>r.charCodeAt(2))?[3,i+r.charCodeAt(2)]:(i+=127&r.charCodeAt(2),i<<=7,i+=127&r.charCodeAt(3),[4,128>r.charCodeAt(3)?i:-i])}(r);return e&&(n+=o[1]),o[1]<0?(o[1]=-o[1],t._complain(i,"Bad byte sequence",r.charCodeAt(0)+"/"+r.charCodeAt(1)+"/"+r.charCodeAt(2)+"/"+r.charCodeAt(3),n)):4==o[0]&&o[1]<2097152?t._complain(i,"Long VLQ value",r.charCodeAt(0)+"/"+r.charCodeAt(1)+"/"+r.charCodeAt(2)+"/"+r.charCodeAt(3),n):3==o[0]&&o[1]<16384?t._complain(i,"Long VLQ value",r.charCodeAt(0)+"/"+r.charCodeAt(1)+"/"+r.charCodeAt(2),n):2==o[0]&&o[1]<128&&t._complain(i,"Long VLQ value",r.charCodeAt(0)+"/"+r.charCodeAt(1),n),o}function x(t,r){if(!(this instanceof x))return new x(t,r);if(this._off=r,this._orig=this,this._tick=0,void 0===t){this.push(new S(0,"\xff/",""));return}for(var i,n,e=0,o=0,s="",h=o+(r+=8);o<t.length;)n=C(this,t.substr(o,4),h,e,!0),o+=n[0],e+=n[1],h=o+r,255==t.charCodeAt(o)?((i=t.substr(o,2)).length<2&&(this._complain(h,"Incomplete track data",3-i.length,e),i="\xff/"),o+=2,n=C(this,t.substr(o,4),h+2,e),o+=n[0],this.push(new S(e,i,t.substr(o,n[1]),h)),o+=n[1]):240==t.charCodeAt(o)||247==t.charCodeAt(o)?(i=t.substr(o,1),o+=1,n=C(this,t.substr(o,4),h+1,e),o+=n[0],this.push(new S(e,i,t.substr(o,n[1]),h)),o+=n[1]):128&t.charCodeAt(o)?(s=t.substr(o,1),o+=1,n=y(s.charCodeAt(0)),s.charCodeAt(0)>240&&this._complain(h,"Unexpected MIDI message",s.charCodeAt(0).toString(16),e),this.push(new S(e,s,_(this,t,o,n,e,h+1),h)),o+=n):128&s.charCodeAt(0)&&(n=y(s.charCodeAt(0)),s.charCodeAt(0)>240&&this._complain(h,"Unexpected MIDI message",s.charCodeAt(0).toString(16),e),this.push(new S(e,s,_(this,t,o,n,e,h),h)),o+=n)}function k(t){var r=t.toString();return r.length>80&&(r=(r=r.substr(0,78)).substr(0,r.lastIndexOf(" "))+" ..."),r}function A(t,r,i){return t.dd.length<i?c(t._off,"Invalid "+r+" meta event: "+(t.dd.length?"data too short":"no data"),k(t),t.tt):t.dd.length>i?c(t._off,"Invalid "+r+" meta event: data too long",k(t),t.tt):void 0}function I(t,r){return c(t._off,r+" meta events must be in the first track",k(t),t.tt)}function b(t,r){var i;if(void 0!==t.ff){if(t.ff>127)return c(t._off,"Invalid meta event",k(t),t.tt);if(0==t.ff){if(i=A(t,"Sequence Number",2))return i}else if(t.ff<10){if(!t.dd.length)return c(t._off,"Invalid Text meta event: no data",k(t),t.tt)}else if(32==t.ff){if(i=A(t,"Channel Prefix",1))return i;if(t.dd.charCodeAt(0)>15)return c(t._off,"Invalid Channel Prefix meta event: incorrect data",k(t),t.tt)}else if(33==t.ff){if(i=A(t,"MIDI Port",1))return i;if(t.dd.charCodeAt(0)>127)return c(t._off,"Invalid MIDI Port meta event: incorrect data",k(t),t.tt)}else if(47==t.ff){if(i=A(t,"End of Track",0))return i}else if(81==t.ff){if(i=A(t,"Tempo",3))return i;if(r&&t.track)return I(t,"Tempo")}else if(84==t.ff){if(i=A(t,"SMPTE",5))return i;if((31&t.dd.charCodeAt(0))>=24||t.dd.charCodeAt(1)>=60||t.dd.charCodeAt(2)>=60||t.dd.charCodeAt(3)>=30||t.dd.charCodeAt(4)>=200||t.dd.charCodeAt(4)%25)return c(t._off,"Invalid SMPTE meta event: incorrect data",k(t),t.tt);if(t.dd.charCodeAt(0)>>5>3)return c(t._off,"Invalid SMPTE meta event: incorrect format",t.dd.charCodeAt(0)>>5,t.tt);if(r&&t.track)return I(t,"SMPTE")}else if(88==t.ff){if(i=A(t,"Time Signature",4))return i;if(t.dd.charCodeAt(1)>8)return c(t._off,"Invalid Time Signature meta event: incorrect data",k(t),t.tt);if(r&&t.track)return I(t,"Time Signature")}else if(89==t.ff){if(i=A(t,"Key Signature",2))return i;if(t.dd.charCodeAt(1)>1||t.dd.charCodeAt(0)>255||t.dd.charCodeAt(0)>7&&249>t.dd.charCodeAt(0))return c(t._off,"Invalid Key Signature meta event: incorrect data",t.toString(),t.tt)}else if(127!=t.ff)return c(t._off,"Unknown meta event",k(t),t.tt)}}function S(r,i,n,e){var o;if(255==i.charCodeAt(0))o=t.MIDI.smf(i.charCodeAt(1),n);else{for(var s=[i.charCodeAt(0)],h=0;h<n.length;h++)s.push(n.charCodeAt(h));o=t.MIDI(s)}return void 0!==e&&(o._off=e),o.tt=r,o}function M(){var i,n=new t.Widget;for(var e in n._info.name="MIDI Player",n._info.manufacturer="Jazz-Soft",n._info.version=r,n.playing=!1,n._loop=0,n._data=[],n._pos=0,n._tick=(i=n,function(){i.tick()}),M.prototype)M.prototype.hasOwnProperty(e)&&(n[e]=M.prototype[e]);return n}function w(t){this._receive(t)}function D(t){return(t.charCodeAt(0)<<16)+(t.charCodeAt(1)<<8)+t.charCodeAt(2)}function N(){o("Not a SYX file")}function q(r){var i=this instanceof q?this:i=new q;if(i._orig=i,void 0!==r){if(r instanceof $)return i.copy(r.player()._data),i;if(r instanceof q)return i.copy(r),i;try{r instanceof ArrayBuffer&&(r=p(new Uint8Array(r)))}catch(n){}try{(r instanceof Uint8Array||r instanceof Int8Array)&&(r=p(new Uint8Array(r)))}catch(e){}try{r instanceof Buffer&&(r=r.toString("binary"))}catch(o){}"string"!=typeof r&&(r=String.fromCharCode.apply(null,r));for(var s,h=[],a=0,f=0;a<r.length;){for(240!=r.charCodeAt(a)&&N();a<r.length;){if(s=r.charCodeAt(a),h.push(s),247==s){(h=t.MIDI(h))._off=f,i.push(t.MIDI(h)),h=[],f=a+1;break}a++}a++}h.length&&N()}return i}function P(){o("Not a MIDI 2.0 Clip file")}function B(t){var r=this instanceof B?this:r=new B;if(r._orig=r,void 0!==t){if(t instanceof B)return r.copy(t),r;try{t instanceof ArrayBuffer&&(t=p(new Uint8Array(t)))}catch(i){}try{(t instanceof Uint8Array||t instanceof Int8Array)&&(t=p(new Uint8Array(t)))}catch(n){}try{t instanceof Buffer&&(t=t.toString("binary"))}catch(e){}return"string"!=typeof t&&(t=String.fromCharCode.apply(null,t)),r.load(t),r}return r.header||(r.header=new T),r}function T(){}});