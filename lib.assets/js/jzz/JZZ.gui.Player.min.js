!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?(i.Player=i,module.exports=i):"function"==typeof define&&define.amd?define("JZZ.gui.Player",["JZZ","JZZ.midi.SMF"],i):i(JZZ)}(this,function(t){if(t.gui||(t.gui={}),!t.gui.Player){var i={on:s,off:s,disable:s,title:s,div:{}},e={container:{backgroundColor:"#888",borderRadius:"0px",borderWidth:"1px"},lbl:{color:"#aaa",fontSize:"12px",fontFamily:"Arial, Helvetica, sans-serif"},btn:{borderRadius:"0px",backgroundColor:{on:"#ddd",off:"#aaa",disable:"#888"},borderColor:{on:"#ccc",off:"#ccc",disable:"#aaa"},svgFill:{on:"#000",off:"#000",disable:"#555"},close:{borderRadius:"0px",backgroundColor:"#f44"}},rail:{borderRadius:"2px",borderWidth:"1px",backgroundColor:{enable:"#ccc",disable:"#888"},borderColor:{enable:"#ccc",disable:"#aaa"}},caret:{borderRadius:"6px",borderWidth:"1px",backgroundColor:{mouseDown:"#ddd",mouseUp:"#aaa",enable:"#aaa",disable:"#888"},borderColor:{enable:"#ccc",disable:"#aaa"}},svg:{play:'<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',pause:'<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',stop:'<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 6h12v12H6z"/></svg>',loop:'<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>',more:'<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>',open:'<svg fill="#555" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M10 4H2v16h20V6H12l-2-2z"/></svg>',link:'<svg fill="#555" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/><path fill="none" d="M0 0h24v24H0z"/></svg>',close:'<svg stroke="#ff8" xmlns="http://www.w3.org/2000/svg" width="7" height="7" viewBox="0 0 7 7"><line x1="1" y1="1" x2="6" y2="6"/><line x1="1" y1="6" x2="6" y2="1"/></svg>'}};n.prototype.on=function(){this.div.style.backgroundColor=e.btn.backgroundColor.on,this.div.style.borderColor=e.btn.borderColor.on,this.div.firstChild.style.fill=e.btn.svgFill.on},n.prototype.off=function(){this.div.style.backgroundColor=e.btn.backgroundColor.off,this.div.style.borderColor=e.btn.borderColor.off,this.div.firstChild.style.fill=e.btn.svgFill.off},n.prototype.disable=function(){this.div.style.backgroundColor=e.btn.backgroundColor.disable,this.div.style.borderColor=e.btn.borderColor.disable,this.div.firstChild.style.fill=e.btn.svgFill.disable},n.prototype.title=function(t){this.div.title=t};var o=0;r.prototype=new t.Widget,r.prototype.constructor=r,r.prototype.label=function(t){this.lbl.innerHTML=t},r.prototype.disable=function(){this.playBtn.disable(),this.pauseBtn.disable(),this.stopBtn.disable(),this.loopBtn.disable(),this.midiBtn.disable(),this._conn&&this.midiBtn.off(),this.fileBtn.off(),this.rail.style.borderColor=e.rail.borderColor.disable,this.rail.style.backgroundColor=e.rail.backgroundColor.disable,this.caret.style.borderColor=e.caret.borderColor.disable,this.caret.style.backgroundColor=e.caret.backgroundColor.disable},r.prototype.enable=function(){this.playBtn.off(),this.pauseBtn.off(),this.stopBtn.off(),this.loopBtn.off(),this._conn&&this.midiBtn.off(),this.rail.style.borderColor=e.rail.borderColor.enable,this.caret.style.backgroundColor=e.caret.backgroundColor.enable,this.caret.style.borderColor=e.caret.borderColor.enable},r.prototype.load=function(t){var i=this;this._player=t.player(),this._player.trim(),this._player.connect(this),this._player.onEnd=function(){i._onEnd()},this._player.filter(this._setfilter),this._sndoff||(this._player.sndOff=s),this.enable(),this.onLoad(t)},r.prototype.filter=function(t){this._setfilter=t instanceof Function?t:void 0,this._player&&this._player.filter(this._setfilter)},r.prototype.onSelect=s,r.prototype.onEnd=s,r.prototype.onLoad=s,r.prototype._onEnd=function(){this.onEnd(),this._loop&&-1!=this._loop&&this._loop--,this._loop?1==this._loop?(this._loop=0,this.loopBtn.off(),this.loopBtn.title("loop")):this.loopBtn.title("loop: "+(-1==this._loop?"∞":this._loop)):(this._moving&&clearInterval(this._moving),this._move(),this._playing=!1,this.playBtn.off())},r.prototype._move=function(){var t=Math.round(this._player.positionMS()*this.rlen/this._player.durationMS())-5;this.caret.style.left=t+"px"},r.prototype.onPlay=s,r.prototype.onResume=s,r.prototype._resume=function(){var t=this;this._player.resume(),this._moving=setInterval(function(){t._move()},100)},r.prototype.play=function(){if(this._player){var i=this;this.playBtn.on(),this.pauseBtn.off(),this._playing||(this._paused?this.onResume():this.onPlay(),this._playing=!0,this._paused=!1,this._out||!this._conn?this._resume():this._waiting||(this._waiting=!0,t().openMidiOut(i._ports).and(function(){i._out=this,i._outname=this.name(),i.midiBtn.title(i._outname),i._connect(this),i._waiting=!1,i.onSelect(i._outname),i._playing&&i._resume()}).or(function(){i._waiting=!1,i._resume()})))}},r.prototype.onStop=s,r.prototype.stop=function(){if(this._player){var i=this;this._player.stop(),t.lib.schedule(function(){i.onStop()}),this._moving&&clearInterval(this._moving),this._playing=!1,this._paused=!1,this.playBtn.off(),this.pauseBtn.off(),this._move()}},r.prototype.onPause=s,r.prototype.pause=function(i){if(this._player){var e=this;this._paused?(void 0===i||i)&&(this._out?(this._resume(),this.onResume(),this._playing=!0,this._paused=!1,this.playBtn.on(),this.pauseBtn.off()):this.play()):this._playing&&(void 0===i||!i)&&(this._player.pause(),t.lib.schedule(function(){e.onPause()}),this._moving&&clearInterval(this._moving),this._playing=!1,this._paused=!0,this.playBtn.off(),this.pauseBtn.on())}},r.prototype.onLoop=s,r.prototype.loop=function(i){if(this._player){var e=this;void 0===i&&(i=!this._loop),i==parseInt(i)&&i>0?this._loop=i:this._loop=i?-1:0,1==this._loop&&(this._loop=0),this._player.loop(this._loop),t.lib.schedule(function(){e.onLoop(i)}),this._loop?(this.loopBtn.on(),this.loopBtn.title("loop: "+(-1==this._loop?"∞":this._loop))):(this.loopBtn.off(),this.loopBtn.title("loop"))}},r.prototype.onClose=s,r.prototype.destroy=function(){if(this.stop(),this._out){var i=this._out;t.lib.schedule(function(){i.close()})}this.gui.parentNode.removeChild(this.gui),this.onClose()},r.prototype.setUrl=function(t,i){this.linkBtn&&(this._url&&(this.linkBtn.div.appendChild(this._url.firstChild),this.linkBtn.div.removeChild(this._url),this._url=void 0),void 0===t?this.linkBtn.disable():(this.linkBtn.off(),this._url=document.createElement("a"),this._url.target="_blank",this._url.appendChild(this.linkBtn.div.firstChild),this.linkBtn.div.appendChild(this._url),this._url.href=t,this._url.dataset||(this._url.dataset={}),this._url.dataset.jzzGuiPlayer=!0,void 0!==i&&(this._url.download=i)))},r.prototype.readFile=function(i){var e=this,o=new FileReader;o.onload=function(o){for(var s,n="",l=new Uint8Array(o.target.result),r=0;r<l.length;r++)n+=String.fromCharCode(l[r]);try{s=new t.MIDI.SYX(n)}catch(a){}try{s||(s=new t.MIDI.SMF(n)),e.stop(),t.lib.schedule(function(){e.load(s)}),e.linkBtn&&e.setUrl("data:audio/midi;base64,"+t.lib.toBase64(n),i.name)}catch(p){console.log(p.message)}},o.readAsArrayBuffer(i)},r.prototype.onSelect=s,r.prototype._closeselect=function(){this.midiBtn.off(),this.sel.style.display="none",this._more=!1},r.prototype.settings=function(){if(!this._more&&this._conn){var i=this;this._more=!0,this.midiBtn.on(),this.sel.style.display="inline-block",t().refresh().and(function(){var t,e=this.info().outputs;for(t=0;t<i.sel.options.length;t++)i.sel.remove(t);for(t=0;t<e.length;t++)i.sel[t]=new Option(e[t].name,e[t].name,e[t].name==i._outname,e[t].name==i._outname);i.sel.size=e.length<2?2:e.length,i.sel.focus()})}},r.prototype._selectMidi=function(){var i=this;t().openMidiOut(this._newname).or(function(){i._newname=void 0,i._closeselect()}).and(function(){if(i._newname=void 0,i._outname!=this.name()){if(i._outname=this.name(),i._closeselect(),i._out){if(i._playing)for(var e=0;e<16;e++)i._out._receive(t.MIDI.allSoundOff(e));i._disconnect(i._out),i._out.close()}i._out=this,i._connect(this),i.midiBtn.title(i._outname),i.onSelect(i._outname),setTimeout(function(){i.onSelect(i._outname)},0)}})},r.prototype.select=function(t){var i=this;this._newname=t||0,this._newname==this._outname?(this._newname=void 0,this._closeselect()):setTimeout(function(){i._selectMidi()},0)},r.prototype._selected=function(){var t=this.sel.options[this.sel.selectedIndex];t&&this.select(t.value)},r.prototype._keydown=function(t){(13==t.keyCode||32==t.keyCode)&&this._selected()},r.prototype.type=function(){return this._player?this._player.type():0},r.prototype.tracks=function(){return this._player?this._player.tracks():0},r.prototype.duration=function(){return this._player?this._player.duration():0},r.prototype.durationMS=function(){return this._player?this._player.durationMS():0},r.prototype.position=function(){return this._player?this._player.position():0},r.prototype.positionMS=function(){return this._player?this._player.positionMS():0},r.prototype.tick2ms=function(){return this._player?this._player.tick2ms():0},r.prototype.ms2tick=function(){return this._player?this._player.ms2tick():0},r.prototype.onJump=s,r.prototype.jump=function(t){this._player&&(this._player.jump(t),this._move(),this._playing||(t?(this._paused=!0,this.playBtn.off(),this.pauseBtn.on()):(this._paused=!1,this.playBtn.off(),this.pauseBtn.off())),this.onJump(this._player.position()))},r.prototype.jumpMS=function(t){this._player&&(this._player.jumpMS(t),this._move(),this._playing||(t?(this._paused=!0,this.playBtn.off(),this.pauseBtn.on()):(this._paused=!1,this.playBtn.off(),this.pauseBtn.off())),this.onJump(this._player.position()))},r.prototype.speed=function(t){return this._player?this._player.speed(t):1},r.prototype._mousedown=function(t){a(t)&&this._player&&(this._more||t.preventDefault(),this.caret.style.backgroundColor=e.caret.backgroundColor.mouseDown,this._wasPlaying=this._playing,this._player.pause(),this._caretX=t.clientX,this._caretPos=parseInt(this.caret.style.left)+5)},r.prototype._startmove=function(t){a(t)&&(this._more||t.preventDefault(),this._startX=parseInt(this.gui.style.left),this._startY=parseInt(this.gui.style.top),this._clickX=t.clientX,this._clickY=t.clientY)},r.prototype._mouseup=function(){this._player&&void 0!==this._caretX&&(this._wasPlaying&&(this._wasPlaying=void 0,this._player.resume()),this.caret.style.backgroundColor=e.caret.backgroundColor.mouseUp,this._caretX=void 0),void 0!==this._startX&&(this._startX=void 0,this._startY=void 0,this._clickX=void 0,this._clickY=void 0)},r.prototype._mousemove=function(t){if(this._more&&(this._startX=void 0,this._startY=void 0,this._clickX=void 0,this._clickY=void 0),this._player&&void 0!==this._caretX){t.preventDefault();var i=this._caretPos+t.clientX-this._caretX;i<0&&(i=0),i>this.rlen&&(i=this.rlen),this.jumpMS(this.durationMS()*i*1/this.rlen)}else void 0!==this._startX&&(t.preventDefault(),this.gui.style.left=this._startX-this._clickX+t.clientX+"px",this.gui.style.top=this._startY-this._clickY+t.clientY+"px")},r.prototype._connect=r.prototype.connect,r.prototype._disconnect=r.prototype.disconnect,r.prototype.connect=function(t){t==this?(this._conn=!0,this.midiBtn.off()):this._connect(t)},r.prototype.disconnect=function(t){t==this?(this._conn=!1,this._out&&this._disconnect(this._out),this._outname=void 0,this.midiBtn.disable()):this._disconnect(t)},r.prototype.connected=function(){return this._outname},t.gui.Player=r,t.gui.Player.Btn=n,t.gui.Player.theme=e}function s(){}function n(t){this.div=document.createElement("div"),this.div.style.display="inline-block",this.div.style.position="absolute",this.div.style.boxSizing="content-box",this.div.style.top="8px",this.div.style.margin="0",this.div.style.padding="2px",this.div.style.borderRadius=e.btn.borderRadius,this.div.style.borderStyle="solid",this.div.style.borderWidth=e.container.borderWidth,this.div.style.borderColor=e.btn.borderColor.disable,this.div.style.backgroundColor=e.btn.backgroundColor.disable,this.div.style.lineHeight="0",this.div.style.lineSpasing="0",this.div.style.width="18px",this.div.style.height="18px",this.div.innerHTML=t}function l(t){t.stopPropagation(),t.preventDefault()}function r(t,s){if(!(this instanceof r))return new r(t,s);var a,p,d,h,c={at:void 0,x:void 0,y:void 0,play:!0,record:!1,pause:!0,stop:!0,loop:!0,file:!1,link:!1,midi:!0,close:!1,sndoff:!0,ports:[void 0,/MIDI Through/i],connect:!0};if("object"==typeof t)for(var u in c)c.hasOwnProperty(u)&&void 0!==t[u]&&(c[u]=t[u]);if(void 0===c.at&&(c.at=t),void 0===c.x&&(c.x=t),void 0===c.y&&(c.y=s),a=this,p=c,a.gui=document.createElement("div"),a.gui.style.display="inline-block",a.gui.style.position="relative",a.gui.style.boxSizing="content-box",a.gui.style.margin="0px",a.gui.style.padding="0px",a.gui.style.borderRadius=e.container.borderRadius,a.gui.style.borderStyle="none",a.gui.style.backgroundColor=e.container.backgroundColor,a.gui.style.width="270px",a.gui.style.height="40px",d=8,h=238,p.play?(a.playBtn=new n(e.svg.play),a.playBtn.div.style.left=d+"px",d+=28,a.playBtn.div.title="play",a.playBtn.div.addEventListener("click",function(){a.play()}),a.gui.appendChild(a.playBtn.div)):a.playBtn=i,p.pause?(a.pauseBtn=new n(e.svg.pause),a.pauseBtn.div.style.left=d+"px",d+=28,a.pauseBtn.div.title="pause",a.pauseBtn.div.addEventListener("click",function(){a.pause()}),a.gui.appendChild(a.pauseBtn.div)):a.pauseBtn=i,p.stop?(a.stopBtn=new n(e.svg.stop),a.stopBtn.div.style.left=d+"px",d+=28,a.stopBtn.div.title="stop",a.stopBtn.div.addEventListener("click",function(){a.stop()}),a.gui.appendChild(a.stopBtn.div)):a.stopBtn=i,p.loop?(a.loopBtn=new n(e.svg.loop),a.loopBtn.div.style.left=d+"px",d+=28,a.loopBtn.div.title="loop",a.loopBtn.div.addEventListener("click",function(){a.loop()}),a.gui.appendChild(a.loopBtn.div)):a.loopBtn=i,p.midi?(a.midiBtn=new n(e.svg.more),a.midiBtn.div.style.left=h+"px",h-=28,a.midiBtn.div.title="midi",a.midiBtn.div.addEventListener("click",function(){a.settings()}),a.gui.appendChild(a.midiBtn.div),a.sel=document.createElement("select"),a.sel.style.position="absolute",a.sel.style.top="30px",a.sel.style.left="40px",a.sel.style.width="230px",a.sel.style.display="none",a.sel.style.zIndex=1,a.sel.addEventListener("click",function(){a._selected()}),a.sel.addEventListener("keydown",function(t){a._keydown(t)}),a.sel.addEventListener("focusout",function(){a._closeselect()}),a.gui.appendChild(a.sel)):a.midiBtn=i,p.link&&(a.linkBtn=new n(e.svg.link),a.linkBtn.div.style.left=h+"px",h-=28,a.linkBtn.div.title="link",a.gui.appendChild(a.linkBtn.div)),p.file?(a.fileBtn=new n(e.svg.open),a.fileBtn.div.style.left=h+"px",h-=28,a.fileBtn.div.title="file",a.gui.appendChild(a.fileBtn.div),a.fileInput=document.createElement("input"),a.fileInput.type="file",a.fileInput.style.position="fixed",a.fileInput.style.visibility="hidden",a.fileInput.accept=".mid, .midi, .kar, .rmi, .syx",a.gui.appendChild(a.fileInput),window.FileReader&&(a.fileBtn.off(),a.fileBtn.div.addEventListener("click",function(){a.fileInput.click()}),a.fileInput.addEventListener("change",function(t){l(t),t.target.files[0]&&a.readFile(t.target.files[0])}),a.gui.addEventListener("drop",function(t){l(t),a.fileBtn.off(),a.readFile(t.dataTransfer.files[0])}),a.gui.addEventListener("dragover",function(t){l(t),a.fileBtn.on(),t.dataTransfer.dropEffect="copy"}),a.gui.addEventListener("dragexit",function(t){l(t),a.fileBtn.off()}))):a.fileBtn=i,p.close&&(a.closeBtn=document.createElement("div"),a.closeBtn.style.display="inline-block",a.closeBtn.style.position="absolute",a.closeBtn.style.boxSizing="content-box",a.closeBtn.style.top="1px",a.closeBtn.style.left="262px",a.closeBtn.style.margin="0",a.closeBtn.style.padding="0",a.closeBtn.style.borderRadius=e.btn.close.borderRadius,a.closeBtn.style.backgroundColor=e.btn.close.backgroundColor,a.closeBtn.style.width="7px",a.closeBtn.style.height="7px",a.closeBtn.style.lineHeight="0",a.closeBtn.style.lineSpasing="0",a.closeBtn.innerHTML=e.svg.close,a.closeBtn.title="close",a.closeBtn.addEventListener("click",function(){a.destroy()}),a.gui.appendChild(a.closeBtn)),a.rlen=h-d+10,a.lbl=document.createElement("div"),a.lbl.style.display="inline-block",a.lbl.style.position="absolute",a.lbl.style.top="26px",a.lbl.style.left=d+"px",a.lbl.style.width=a.rlen+10+"px",a.lbl.style.height="12px",a.lbl.style.padding="0",a.lbl.style.textAlign="center",a.lbl.style.color=e.lbl.color,a.lbl.style.fontSize=e.lbl.fontSize,a.lbl.style.fontFamily=e.lbl.fontFamily,a.gui.appendChild(a.lbl),a.rail=document.createElement("div"),a.rail.style.display="inline-block",a.rail.style.position="absolute",a.rail.style.boxSizing="content-box",a.rail.style.top="19px",a.rail.style.left=d+5+"px",a.rail.style.width=a.rlen+"px",a.rail.style.height="0",a.rail.style.padding="1px",a.rail.style.borderStyle="solid",a.rail.style.borderWidth=e.rail.borderWidth,a.rail.style.borderRadius=e.rail.borderRadius,a.rail.style.borderColor=e.rail.borderColor.disable,a.rail.style.backgroundColor=e.rail.backgroundColor.disable,a.gui.appendChild(a.rail),a.caret=document.createElement("div"),a.caret.style.display="inline-block",a.caret.style.position="absolute",a.caret.style.boxSizing="content-box",a.caret.style.width="2px",a.caret.style.height="2px",a.caret.style.top="-5px",a.caret.style.left="-5px",a.caret.style.padding="4px",a.caret.style.borderStyle="solid",a.caret.style.borderWidth=e.caret.borderWidth,a.caret.style.borderRadius=e.caret.borderRadius,a.caret.style.borderColor=e.caret.borderColor.disable,a.caret.style.backgroundColor=e.caret.backgroundColor.disable,a.caret.addEventListener("mousedown",function(t){a._mousedown(t)}),a.rail.appendChild(a.caret),window.addEventListener("mousemove",function(t){a._mousemove(t)}),window.addEventListener("mouseup",function(t){a._mouseup(t)}),c.ports instanceof Array||(c.ports=[c.ports]),c.ports.push(void 0),this._ports=c.ports,this._conn=c.connect,this._sndoff=c.sndoff,this.disable(),"string"==typeof c.at)try{return document.getElementById(c.at).appendChild(this.gui),this}catch(y){}try{return c.at.appendChild(this.gui),this}catch(f){}(c.x!=parseInt(c.x)||c.y!=parseInt(c.y))&&(c.x=15*o+5,c.y=45*o+5,o++),this.gui.style.position="fixed",this.gui.style.top=c.y+"px",this.gui.style.left=c.x+"px",this.gui.style.opacity=.9;var v=this;this.gui.addEventListener("mousedown",function(t){v._startmove(t)}),document.body.appendChild(this.gui)}function a(t){return void 0===t.buttons?!t.button:1&t.buttons}});