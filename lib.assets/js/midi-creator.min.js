class MidiCreator{constructor(t){t=t||{},this.tempo=t.tempo||130,this.ppqn=t.ppqn||96,this.maxTempo=t.maxTempo||720,this.channel=t.channel||0,this.pitchMin=t.pitchMin||20,this.pitchMax=t.pitchMax||2e4,this.thresholdRms=t.thresholdRms||.01,this.thresholdAmplitude=t.thresholdAmplitude||.2,this.resolution=t.resolution||32,this.sampleRate=t.sampleRate||32e3,this.minSample=this.minSample||500,this.barDuration=60/(this.tempo*this.ppqn),this.timeOffset=0,this.midiData=[],this.lastNote=null,this.lastTime=0,this.waveformArray=null,this.noteFlats="C Db D Eb E F Gb G Ab A Bb B".split(" "),this.noteSharps="C C# D D# E F F# G G# A A# B".split(" "),this.minInterval=6e4/(this.tempo*this.resolution),this.onPreviewNote=function(t){},this.noteFromPitch=function(t){return Math.round(12*(Math.log(t/440)/Math.log(2)))+69},this.frequencyFromNoteNumber=function(t){return 440*Math.pow(2,(t-69)/12)},this.centsOffFromPitch=function(t,i){return Math.floor(1200*Math.log(t/frequencyFromNoteNumber(i))/Math.log(2))},this.pitchFromNote=function(t){let i=[];i=-1!=t.indexOf("#")?this.noteSharps:this.noteFlats;let e=t.replace(/[0-9]/g,""),s=parseInt(t.replace(/[^0-9]/g,"")),n=i.indexOf(e);if(-1==n)throw Error("Invalid note name");return this.pitchFromIndexAndOctave(n,s)},this.pitchFromIndexAndOctave=function(t,i){return 440*Math.pow(Math.pow(2,1/12),12*i+t-57)},this.octaveFromNote=function(t){return parseInt(t/12)-1},this.resetMidi=function(){this.timeOffset=this.now(),this.midiData=[],this.lastNote=null},this.addNote=function(t,i,e,s){if(!s&&(t<this.pitchMin||t>this.pitchMax)||(e=e||this.now(),!s&&e-this.lastTime<this.minInterval))return;this.lastTime=e;let n=this.noteFromPitch(t);(i=40+200*i)>127&&(i=127);let h=!1;if(!h&&null==n&&null!=this.lastNote&&!isNaN(this.lastNote)){if(this.midiData.length>0){let a=this.midiData[this.midiData.length-1].time;this.midiData[this.midiData.length-1].duration=e-this.timeOffset-a}h=!0}if(!h&&null!=n&&!isNaN(n)){if(this.midiData.length>0){let o=this.midiData[this.midiData.length-1].time;this.midiData[this.midiData.length-1].duration=e-o,this.midiData[this.midiData.length-1].close=!0}if(n!=this.lastNote){let r={name:this.noteFromNumber(n,!1),midi:n,velocity:Math.round(i),time:e,duration:.1,close:!1};this.midiData.push(r),this.onPreviewNote(r)}}this.lastNote=n},this.now=function(){return new Date().getTime()},this.midiTime=function(t){return Math.round(t/this.barDuration/1e3)},this.createMidi=function(t){let i=new JZZ.MIDI.SMF(0,this.ppqn),e=new JZZ.MIDI.SMF.MTrk;e.add(0,JZZ.MIDI.smfBPM(this.tempo));let s=0,n=0;for(let h in this.midiData[this.midiData.length-1].close&&(this.midiData[this.midiData.length-1].duration=this.now()-this.midiData[this.midiData.length-1].start),this.midiData)if(s=this.midiTime(this.midiData[h].time),e.add(s,JZZ.MIDI.noteOn(this.channel,this.midiData[h].name,this.midiData[h].velocity)),isNaN(n=this.midiTime(this.midiData[h].time+this.midiData[h].duration)))n=s;else{let a=JZZ.MIDI.noteOff(this.channel,this.midiData[h].name);e.add(n,a)}e.add(n,JZZ.MIDI.smfEndOfTrack()),i.push(e);let o=i.dump();return t?o:JZZ.lib.toBase64(o)},this.noteFromNumber=function(t,i){t=Math.round(t);let e;return(!0===i?this.noteSharps:this.noteFlats)[t%12]+(Math.floor(t/12)-1)},this.autoCorrelate=function(t,i){let e=t.length,s=0,n=0,h=0;for(let a=0;a<e;a++){let o=t[a];s+=o*o,h+=Math.abs(o)}if(n=h/e,(s=Math.sqrt(s/e))<.01)return{pitch:-1,rms:s,velocity:n};let r=0,l=e-1;for(let m=0;m<e/2;m++)if(.2>Math.abs(t[m])){r=m;break}for(let d=1;d<e/2;d++)if(.2>Math.abs(t[e-d])){l=e-d;break}let u=Array(e=(t=t.slice(r,l)).length).fill(0);for(let f=0;f<e;f++)for(let c=0;c<e-f;c++)u[f]=u[f]+t[c]*t[c+f];let $=0;for(;u[$]>u[$+1];)$++;let p=-1,D=-1;for(let _=$;_<e;_++)u[_]>p&&(p=u[_],D=_);let g=D,w=u[g-1],v=u[g],F=u[g+1];return{pitch:i/(g=this.fixPitch(g,(w+F-2*v)/2,(F-w)/2)),rms:s,velocity:n}},this.fixPitch=function(t,i,e){return i&&(t-=e/(2*i)),t},this.loadRemoteAudioFile=function(t,e){let s=new AudioContext({sampleRate:this.sampleRate}),n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer";let h=null;n.onload=()=>{s.decodeAudioData(n.response).then(t=>{h=t.getChannelData(0),i.waveformArray=h,"function"==typeof e&&e(h)}).catch(t=>{console.error(t)})},n.send()},this.loadLocalAudioFile=function(t,e){let s=new AudioContext({sampleRate:this.sampleRate});var n=new FileReader;n.onload=function(t){let n=null;s.decodeAudioData(t.target.result).then(function(t){n=t.getChannelData(0),i.waveformArray=n,"function"==typeof e&&e(n)})},n.readAsArrayBuffer(t)},this.chunkSize=function(){return 240*this.sampleRate/(this.tempo*this.resolution)},this.getCurrentTime=function(t){return 6e4*t/(this.tempo*this.sampleRate)},this.soundToNote=function(){this.resetMidi();let t=this.waveformArray.length-1,i=this.chunkSize(),e=0,s=0,n={};do{s=this.getEnd(e,s,t,i),n=this.getOffset(e,s);let h=this.waveformArray.slice(n.start,n.end),a=this.autoCorrelate(h,this.sampleRate);if(void 0!==a.pitch){let o=this.getCurrentTime(e);this.addNote(a.pitch,a.velocity,o)}e=s}while(s<t);return this},this.getEnd=function(t,i,e,s){return(i=t+s)>e&&(i=e),i},this.getOffset=function(t,i){let e=i;return e-t>this.minSample&&(e=t+this.minSample),{start:t,end:e}};let i=this}}