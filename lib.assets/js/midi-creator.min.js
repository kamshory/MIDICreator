class MidiCreator{constructor(t){t=t||{},this.tempo=t.tempo||130,this.ppqn=t.ppqn||96,this.maxTempo=t.maxTempo||720,this.channel=t.channel||0,this.pitchMin=t.pitchMin||20,this.pitchMax=t.pitchMax||2e4,this.thresholdRms=t.thresholdRms||.01,this.thresholdAmplitude=t.thresholdAmplitude||.2,this.resolution=t.resolution||32,this.sampleRate=t.sampleRate||32e3,this.minSample=this.minSample||500,this.barDuration=60/(this.tempo*this.ppqn),this.timeOffset=0,this.midiData=[],this.lastNote=null,this.lastTime=0,this.waveformArray=null,this.noteFlats="C Db D Eb E F Gb G Ab A Bb B".split(" "),this.noteSharps="C C# D D# E F F# G G# A A# B".split(" "),this.minInterval=6e4/(this.tempo*this.resolution),this.sumPitch=0,this.countPitch=0,this.onPreviewNote=function(t){},this.noteFromPitch=function(t){return Math.round(12*(Math.log(t/440)/Math.log(2)))+69},this.frequencyFromNoteNumber=function(t){return 440*Math.pow(2,(t-69)/12)},this.centsOffFromPitch=function(t,i){return Math.floor(1200*Math.log(t/frequencyFromNoteNumber(i))/Math.log(2))},this.pitchFromNote=function(t){let i=[];i=-1!=t.indexOf("#")?this.noteSharps:this.noteFlats;let e=t.replace(/[0-9]/g,""),s=parseInt(t.replace(/[^0-9]/g,"")),h=i.indexOf(e);if(-1==h)throw Error("Invalid note name");return this.pitchFromIndexAndOctave(h,s)},this.pitchFromIndexAndOctave=function(t,i){return 440*Math.pow(Math.pow(2,1/12),12*i+t-57)},this.octaveFromNote=function(t){return parseInt(t/12)-1},this.resetMidi=function(){this.timeOffset=this.now(),this.midiData=[],this.lastNote=null},this.isInvalidPitch=function(t,i){return!i&&(t<this.pitchMin||t>this.pitchMax)},this.isInvalidInterval=function(t,i){return!i&&t-this.lastTime<this.minInterval},this.getVelocity=function(t){let i=40+200*t;return i>127&&(i=127),i},this.addPitch=function(t){this.sumPitch+=t,this.countPitch++},this.clearPitch=function(){let t=this.getPitchAverage();return this.sumPitch=0,this.countPitch=0,t},this.getPitchAverage=function(){return 0==this.countPitch?0:this.sumPitch/this.countPitch},this.addNote=function(t,i,e,s){if(this.isInvalidPitch(t,s)||(this.addPitch(t),e=e||this.now(),this.isInvalidInterval(e,s)))return;this.lastTime=e;let h=this.noteFromPitch(this.clearPitch()),n=this.getVelocity(i),a=!1;if(!a&&null==h&&null!=this.lastNote&&!isNaN(this.lastNote)){if(this.midiData.length>0){let o=this.midiData[this.midiData.length-1].time;this.midiData[this.midiData.length-1].duration=e-this.timeOffset-o}a=!0}if(!a&&null!=h&&!isNaN(h)){if(this.midiData.length>0){let r=this.midiData[this.midiData.length-1].time;this.midiData[this.midiData.length-1].duration=e-r,this.midiData[this.midiData.length-1].close=!0}if(h!=this.lastNote){let l={name:this.noteFromNumber(h,!1),midi:h,velocity:Math.round(n),time:e,duration:.1,close:!1};this.midiData.push(l),this.onPreviewNote(l)}}this.lastNote=h},this.now=function(){return new Date().getTime()},this.midiTime=function(t){return Math.round(t/this.barDuration/1e3)},this.createMidi=function(t){let i=new JZZ.MIDI.SMF(0,this.ppqn),e=new JZZ.MIDI.SMF.MTrk;e.add(0,JZZ.MIDI.smfBPM(this.tempo));let s=0,h=0;for(let n in this.midiData[this.midiData.length-1].close||(this.midiData[this.midiData.length-1].duration=this.now()-this.midiData[this.midiData.length-1].start,this.midiData[this.midiData.length-1].close=!0),this.midiData)if(s=this.midiTime(this.midiData[n].time),e.add(s,JZZ.MIDI.noteOn(this.channel,this.midiData[n].name,this.midiData[n].velocity)),isNaN(h=this.midiTime(this.midiData[n].time+this.midiData[n].duration)))h=s;else{let a=JZZ.MIDI.noteOff(this.channel,this.midiData[n].name);e.add(h,a)}e.add(h,JZZ.MIDI.smfEndOfTrack()),i.push(e);let o=i.dump();return t?o:JZZ.lib.toBase64(o)},this.noteFromNumber=function(t,i){t=Math.round(t);let e;return(!0===i?this.noteSharps:this.noteFlats)[t%12]+(Math.floor(t/12)-1)},this.autoCorrelate=function(t,i){let e=t.length,s=0,h=0,n=0;for(let a=0;a<e;a++){let o=t[a];s+=o*o,n+=Math.abs(o)}if(h=n/e,(s=Math.sqrt(s/e))<.01)return{pitch:-1,rms:s,velocity:h};let r=0,l=e-1;for(let m=0;m<e/2;m++)if(.2>Math.abs(t[m])){r=m;break}for(let u=1;u<e/2;u++)if(.2>Math.abs(t[e-u])){l=e-u;break}let c=Array(e=(t=t.slice(r,l)).length).fill(0);for(let d=0;d<e;d++)for(let f=0;f<e-d;f++)c[d]=c[d]+t[f]*t[f+d];let $=0;for(;c[$]>c[$+1];)$++;let p=-1,D=-1;for(let _=$;_<e;_++)c[_]>p&&(p=c[_],D=_);let g=D,v=c[g-1],P=c[g],w=c[g+1];return{pitch:i/(g=this.fixPitch(g,(v+w-2*P)/2,(w-v)/2)),rms:s,velocity:h}},this.fixPitch=function(t,i,e){return i&&(t-=e/(2*i)),t},this.loadRemoteAudioFile=function(t,e){let s=new AudioContext({sampleRate:this.sampleRate}),h=new XMLHttpRequest;h.open("GET",t,!0),h.responseType="arraybuffer";let n=null;h.onload=()=>{s.decodeAudioData(h.response).then(t=>{n=t.getChannelData(0),i.waveformArray=n,"function"==typeof e&&e(n)}).catch(t=>{console.error(t)})},h.send()},this.loadLocalAudioFile=function(t,e){let s=new AudioContext({sampleRate:this.sampleRate});var h=new FileReader;h.onload=function(t){let h=null;s.decodeAudioData(t.target.result).then(function(t){h=t.getChannelData(0),i.waveformArray=h,"function"==typeof e&&e(h)})},h.readAsArrayBuffer(t)},this.getChunkSize=function(){return 240*this.sampleRate/(this.tempo*this.resolution)},this.getCurrentTime=function(t){return 6e4*t/(this.tempo*this.sampleRate)},this.soundToNote=function(){this.resetMidi();let t=this.waveformArray.length-1,i=this.getChunkSize(),e=0,s=0,h={};do{s=this.getEnd(e,s,t,i),h=this.getOffset(e,s);let n=this.waveformArray.slice(h.start,h.end),a=this.autoCorrelate(n,this.sampleRate);if(void 0!==a.pitch){let o=this.getCurrentTime(e);this.addNote(a.pitch,a.velocity,o)}e=s}while(s<t);return this},this.getEnd=function(t,i,e,s){return(i=t+s)>e&&(i=e),i},this.getOffset=function(t,i){let e=i;return e-t>this.minSample&&(e=t+this.minSample),{start:t,end:e}};let i=this}}