let audioPicker,midiCreator,tempo=80,maxTempo=720,resolution=32,channel=3,sampleRate=32e3,init=!1,player,playing=!1;function highlight(e){e.target.classList.add("highlight")}function unhighlight(e){e.target.classList.remove("highlight")}function preventDefaults(e){e.preventDefault(),e.stopPropagation()}function handleClick(e){document.querySelector("#localfile").click()}function handleDrop(e){handleFiles(e.dataTransfer.files)}function handleFiles(e){[...e].forEach(processLocalFile)}function initPlayer(){init||(JZZ.synth.Tiny.register("Web Audio"),(player=new JZZ.gui.Player("player")).onPlay=function(){playing=!0},player.onStop=function(){playing=!1},player.onPause=function(){playing=!1}),init=!0}function playMidi(e){initPlayer(),playing&&player.stop(),player.load(new JZZ.MIDI.SMF(e))}function processLocalFile(e){let t=new MidiCreator({tempo:tempo,maxTempo:maxTempo,resolution:resolution,channel:channel,sampleRate:sampleRate});t.loadLocalAudioFile(e,function(e){t.soundToNote();var i=t.createMidi(!0);playMidi(i);let o=JZZ.lib.toBase64(i);window.open("data:audio/midi;base64,"+o)})}function processRemoteFile(e){let t=new MidiCreator({tempo:tempo,maxTempo:maxTempo,resolution:resolution,channel:channel,sampleRate:sampleRate});t.loadRemoteAudioFile(e,function(e){t.soundToNote();var i=t.createMidi(!0);playMidi(i);let o=JZZ.lib.toBase64(i);window.open("data:audio/midi;base64,"+o)})}function createPianoRoll(e){let t=12;e.style.width=7*Math.floor((132-t)/12)*16+"px";for(let i=t;i<132;i++){let o=document.createElement("div"),n=Math.floor((i-t)/12),a=inf[i%12];1==a.type&&(o.className="tuts tuts-white",o.setAttribute("data-index",i),o.style.left=7*n*16+16*a.offset+"px",o.style.width=16*a.width+"px",e.appendChild(o))}for(let l=t;l<132;l++){let r=document.createElement("div"),d=Math.floor((l-t)/12),s=inf[l%12];2==s.type&&(r.className="tuts tuts-black",r.setAttribute("data-index",l),r.style.left=7*d*16+16*s.offset+"px",r.style.width=16*s.width+"px",e.appendChild(r))}}function tutsKey(e){}window.onload=function(){let e=document.querySelector(".piano-roll");(audioPicker=new SoundPicker).onStartRecording=function(t){console.log("start recording"),(midiCreator=new MidiCreator({tempo:tempo,maxTempo:maxTempo,resolution:resolution,sampleRate:t,channel:channel})).onPreviewNote=function(t){let i=e.querySelectorAll(".note-on");if(null!=i)for(let o=0;o<i.length;o++)i[o].classList.remove("note-on");let n=e.querySelector('[data-index="'+t.midi+'"]');null!=n&&n.classList.add("note-on")}},audioPicker.onStopRecording=function(e){console.log("stop recording ",e);let t=midiCreator.createMidi();window.open("data:audio/midi;base64,"+t)},audioPicker.onProcessSample=function(e,t){midiCreator.addNote(t.pitch,t.velocity,e)},createPianoRoll(e);let t=document.querySelector(".button--open");["dragenter","dragover","dragleave","drop"].forEach(e=>{t.addEventListener(e,preventDefaults,!1)}),["dragenter","dragover"].forEach(e=>{t.addEventListener(e,highlight,!1)}),["dragleave","drop"].forEach(e=>{t.addEventListener(e,unhighlight,!1)}),t.addEventListener("drop",handleDrop,!1),t.addEventListener("click",handleClick,!1),document.querySelector("#localfile").addEventListener("change",function(e){handleFiles(e.target.files)})};let inf=[{type:1,offset:0,width:1},{type:2,offset:.5,width:.8},{type:1,offset:1,width:1},{type:2,offset:1.7,width:.8},{type:1,offset:2,width:1},{type:1,offset:3,width:1},{type:2,offset:3.5,width:.8},{type:1,offset:4,width:1},{type:2,offset:4.6,width:.8},{type:1,offset:5,width:1},{type:1,offset:6,width:1},{type:2,offset:5.7,width:.8},];