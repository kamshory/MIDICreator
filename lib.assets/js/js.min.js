let audioPicker,midiCreator,tempo=80,maxTempo=720,resolution=16,channel=3,sampleRate=32e3,init=!1,player,playing=!1,lastMidiData,timeout=null,noteOff=1e3;function initPlayer(){init||(JZZ.synth.Tiny.register("Web Audio"),(player=new JZZ.gui.Player("player")).onPlay=function(){playing=!0},player.onStop=function(){playing=!1},player.onPause=function(){playing=!1}),init=!0}function playMidi(e){lastMidiData=e,initPlayer(),playing&&player.stop(),player.load(new JZZ.MIDI.SMF(e));let t=document.querySelector(".button--midi").classList;null!=t&&t.contains("button--disabled")&&document.querySelector(".button--midi").classList.remove("button--disabled")}function downloadMidi(){window.open("data:audio/midi;base64,"+JZZ.lib.toBase64(lastMidiData))}function clearNote(){null!=timeout&&clearTimeout(timeout);let e=document.querySelectorAll(".piano-roll .note-on");if(null!=e)for(let t=0;t<e.length;t++)e[t].classList.remove("note-on")}function highlight(e){e.target.classList.add("highlight")}function unhighlight(e){e.target.classList.remove("highlight")}function preventDefaults(e){e.preventDefault(),e.stopPropagation()}function handleClick(e){document.querySelector("#localfile").click()}function handleDrop(e){handleFiles(e.dataTransfer.files)}function handleFiles(e){[...e].forEach(processLocalFile)}function processLocalFile(e){let t=new MidiCreator({tempo:tempo,maxTempo:maxTempo,resolution:resolution,channel:channel,sampleRate:sampleRate});t.loadLocalAudioFile(e,function(e){t.soundToNote(),playMidi(t.createMidi(!0))})}function processRemoteFile(e){let t=new MidiCreator({tempo:tempo,maxTempo:maxTempo,resolution:resolution,channel:channel,sampleRate:sampleRate});t.loadRemoteAudioFile(e,function(e){t.soundToNote(),playMidi(t.createMidi(!0))})}function createPianoRoll(e){let t=12;e.style.width=7*Math.floor((132-t)/12)*16+"px";for(let i=t;i<132;i++){let o=document.createElement("div"),n=Math.floor((i-t)/12),l=inf[i%12];1==l.type&&(o.className="tuts tuts-white",o.setAttribute("data-index",i),o.style.left=7*n*16+16*l.offset+"px",o.style.width=16*l.width+"px",e.appendChild(o))}for(let a=t;a<132;a++){let r=document.createElement("div"),d=Math.floor((a-t)/12),s=inf[a%12];2==s.type&&(r.className="tuts tuts-black",r.setAttribute("data-index",a),r.style.left=7*d*16+16*s.offset+"px",r.style.width=16*s.width+"px",e.appendChild(r))}}function tutsKey(e){}window.onload=function(){let e=document.querySelector(".piano-roll");(audioPicker=new SoundPicker).onStartRecording=function(t){(midiCreator=new MidiCreator({tempo:tempo,maxTempo:maxTempo,resolution:resolution,sampleRate:t,channel:channel})).onPreviewNote=function(t){clearNote();let i=e.querySelector('[data-index="'+t.midi+'"]');null!=i&&(i.classList.add("note-on"),timeout=setTimeout(function(){clearNote()},noteOff))}},audioPicker.onStopRecording=function(e){clearNote();playMidi(midiCreator.createMidi(!0))},audioPicker.onProcessSample=function(e,t){midiCreator.addNote(t.pitch,t.velocity,e)},createPianoRoll(e);let t=document.querySelector(".button--open");["dragenter","dragover","dragleave","drop"].forEach(e=>{t.addEventListener(e,preventDefaults,!1)}),["dragenter","dragover"].forEach(e=>{t.addEventListener(e,highlight,!1)}),["dragleave","drop"].forEach(e=>{t.addEventListener(e,unhighlight,!1)}),t.addEventListener("drop",handleDrop,!1),t.addEventListener("click",handleClick,!1),document.querySelector("#localfile").addEventListener("change",function(e){handleFiles(e.target.files)}),document.querySelector(".button--midi").addEventListener("click",function(e){downloadMidi(),e.preventDefault()})};let inf=[{type:1,offset:0,width:1},{type:2,offset:.5,width:.8},{type:1,offset:1,width:1},{type:2,offset:1.7,width:.8},{type:1,offset:2,width:1},{type:1,offset:3,width:1},{type:2,offset:3.5,width:.8},{type:1,offset:4,width:1},{type:2,offset:4.6,width:.8},{type:1,offset:5,width:1},{type:1,offset:6,width:1},{type:2,offset:5.7,width:.8},];